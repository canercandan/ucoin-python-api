stages:
  - format
  - test
  - build
  - release

variables:
    PYENV_PYTHON_VERSION: 3.5.5

image: registry.duniter.org/docker/python3/duniterpy-builder:0.0.4

# SUB-TASKS
.push_to_github:
  tags:
    - github
  after_script:
    # remove last clone
    - rm -rf ./*
    - rm -rf .git
    # do a mirror clone
    - git clone --mirror $CI_REPOSITORY_URL .
    - git remote add github $GITHUB_URL_AND_KEY
    - git config --global user.email "contact@duniter.org"
    - git config --global user.name "Duniter"
    # Job would fail if we don't remove refs about pull requests
    - bash -c "cat packed-refs | grep -v 'refs/pull' > packed-refs-new; echo 'Removed pull refs.'"
    - mv packed-refs-new packed-refs
    - bash -c "git push --force --mirror github 2>&1 | grep -v duniter-gitlab; echo $?"

.pyenv:
  tags:
    - redshift-docker-python
  before_script:
    - export PYENV_ROOT="$HOME/.pyenv"
    - export PATH="$PYENV_ROOT/bin:$PATH"
    - eval "$(pyenv init -)"
    - pyenv shell $PYENV_PYTHON_VERSION

.changes:
  only:
    changes:
      - duniterpy/**/*.py
      - .gitlab-ci.yml
      - Makefile
      - requirements_dev.txt
      - requirements.txt
      - setup.py
      - tests/**/*.py

# TASKS
format:
  extends:
    - .pyenv
    - .changes
  stage: format
  script:
    - pyenv shell 3.6.4  # black install and run needs python 3.6.x minimum
    - pip install -r requirements_dev.txt
    - make check-format

test:
  extends:
    - .pyenv
    - .changes
  stage: test
  script:
    - pip install -r requirements.txt
    - make tests

check:
  extends:
    - .pyenv
    - .changes
  stage: test
  script:
    - pyenv shell 3.6.4  # black install needs python 3.6.x minimum
    - pip install -r requirements.txt
    - pip install -r requirements_dev.txt
    - make mypy
    - make pylint

build:
  extends:
    - .pyenv
    - .changes
  stage: build
  script:
    - pip install -r requirements.txt
    - pip install -r requirements_deploy.txt
    - make build

release:
  extends:
    - .pyenv
    - .push_to_github
  stage: release
  when: manual
  script:
    - pip install -r requirements.txt
    - pip install -r requirements_deploy.txt
    - make build
    - make deploy PYPI_LOGIN=${PYPI_LOGIN} PYPI_PASSWORD=${PYPI_PASSWORD}
  only:
    - tags

release_test:
  extends: .pyenv
  stage: release
  when: manual
  script:
    - pip install -r requirements.txt
    - pip install -r requirements_deploy.txt
    - make build
    - make deploy_test PYPI_TEST_LOGIN=${PYPI_TEST_LOGIN} PYPI_TEST_PASSWORD=${PYPI_TEST_PASSWORD}
